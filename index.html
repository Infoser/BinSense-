<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Waste Management</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body { font-family: Arial, sans-serif; }
        #map { height: 500px; width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

    <h2>Smart Waste Management Map</h2>
    <div id="map"></div>
    <p id="status">Loading...</p>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Initialize Map
            var map = L.map('map').setView([21.2514, 81.6296], 14);

            // Add OpenStreetMap Layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Force Map to Render Properly
            setTimeout(() => { map.invalidateSize(); }, 1000);

            // Icons for different fill levels
            var greenBinIcon = L.icon({
                iconUrl: 'green_bin.jpg',
                iconSize: [32, 32]
            });

            var yellowBinIcon = L.icon({
                iconUrl: 'yellow_dustbin.jpg',
                iconSize: [32, 32]
            });

            var redBinIcon = L.icon({
                iconUrl: 'red_dustbin.jpg',
                iconSize: [32, 32]
            });

            // Marker Placeholder
            var binMarker = L.marker([21.2514, 81.6296], { icon: greenBinIcon }).addTo(map).bindPopup("Loading...");

            // Function to Fetch Data from ThingSpeak
            function fetchThingSpeakData() {
                fetch('https://api.thingspeak.com/channels/2832905/fields/1.json?results=1')
                    .then(response => response.json())
                    .then(data => {
                        if (data.feeds.length > 0) {
                            let latestData = data.feeds[0];
                            let fillLevel = parseFloat(latestData.field1);  // Bin Fill Percentage
                            
                            // Fake Coordinates for Testing
                            let binLat = 21.2514 + (Math.random() * 0.005);
                            let binLng = 81.6296 + (Math.random() * 0.005);

                            // Determine Icon Based on Fill Level
                            let selectedIcon = greenBinIcon;  // Default Green
                            if (fillLevel >= 45 && fillLevel <= 74) {
                                selectedIcon = yellowBinIcon;  // Yellow
                            } else if (fillLevel >= 75) {
                                selectedIcon = redBinIcon;  // Red
                            }

                            // Update Marker Position & Icon
                            binMarker.setLatLng([binLat, binLng])
                                .setIcon(selectedIcon)
                                .bindPopup(`Bin Fill Level: ${fillLevel.toFixed(2)}%`)
                                .openPopup();

                            // Update Status
                            document.getElementById("status").innerText = `Latest Bin Level: ${fillLevel.toFixed(2)}%`;
                        }
                    })
                    .catch(error => console.error("Error fetching data:", error));
            }

            // Call Function Every 15 Seconds
            fetchThingSpeakData();
            setInterval(fetchThingSpeakData, 15000);
        });
    </script>

</body>
</html>
